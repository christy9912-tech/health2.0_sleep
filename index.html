<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>睡眠角色互動實驗室 - Health 2.0 Insights</title>
    <!-- 引入 Tailwind CSS 與 Lucide 圖示庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background-color: #0a0a0a;
            color: #ededed;
        }

        /* 自定義捲軸樣式 */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #262626; border-radius: 10px; }

        /* 動畫與過渡 */
        .persona-card:hover .card-img { transform: scale(1.05); }
        .chat-bubble-user { background-color: #4f46e5; border-bottom-right-radius: 2px; }
        .chat-bubble-ai { background-color: #262626; border-bottom-left-radius: 2px; border: 1px solid #3f3f46; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .dot-loading { animation: bounce-slow 0.6s infinite; }
    </style>
</head>
<body class="min-h-screen selection:bg-indigo-500/30">

    <!-- API KEY 設定區 -->
    <script>
        // 在下方引號內填入您的 Gemini API Key
        const API_KEY = "AIzaSyB0yo01sjHP8MOVbf5QSJndrZzJz67vCw8"; 
    </script>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 border-b border-neutral-800 pb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-white flex items-center gap-3 tracking-tighter">
                    <i data-lucide="moon" class="text-indigo-500"></i> 睡眠角色互動實驗室
                </h1>
                <p class="text-neutral-500 text-xs mt-1 uppercase tracking-[0.2em] font-bold opacity-60">Health 2.0 Audience Insights</p>
            </div>
            <div id="back-btn-container" class="hidden">
                <button onclick="resetApp()" class="text-neutral-400 hover:text-white flex items-center gap-1 text-xs font-bold uppercase tracking-widest transition-colors">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i> 返回列表
                </button>
            </div>
        </header>

        <!-- 角色選擇列表 -->
        <div id="selection-screen" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- 角色卡片由 JavaScript 動態插入 -->
        </div>

        <!-- 主互動介面 -->
        <div id="main-interface" class="hidden grid lg:grid-cols-12 gap-8 h-[78vh]">
            <!-- 側邊欄 -->
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="bg-neutral-900 border border-neutral-800 rounded-3xl overflow-hidden shadow-2xl relative">
                    <div id="character-photo-container" class="aspect-[4/5] bg-neutral-800 relative flex items-center justify-center">
                        <div id="photo-loading" class="flex flex-col items-center gap-2">
                            <i data-lucide="loader-2" class="animate-spin text-indigo-500 w-8 h-8"></i>
                            <span class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest">Rendering Reality...</span>
                        </div>
                        <img id="character-photo" src="" class="hidden w-full h-full object-cover" alt="Persona">
                        <div class="absolute inset-0 bg-gradient-to-t from-neutral-950 via-transparent to-transparent opacity-80"></div>
                        <div class="absolute bottom-6 left-6 pr-6">
                            <h2 id="character-name" class="text-3xl font-black"></h2>
                            <p id="character-info" class="text-neutral-400 text-sm font-medium mb-2"></p>
                            <div id="character-tags" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
                <button id="analysis-btn" onclick="runAnalysis()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-sm hover:bg-indigo-500 transition-all flex items-center justify-center gap-3 disabled:opacity-50 shadow-lg">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i> 產生戰略報告
                </button>
            </div>

            <!-- 對話區 -->
            <div class="lg:col-span-8 flex flex-col bg-neutral-900 border border-neutral-800 rounded-3xl overflow-hidden shadow-2xl relative">
                
                <div id="chat-container" class="flex flex-col h-full">
                    <div id="messages-list" class="flex-1 p-6 md:p-8 overflow-y-auto custom-scrollbar space-y-6 bg-gradient-to-b from-indigo-500/5 to-transparent">
                    </div>
                    
                    <div class="p-6 bg-neutral-900 border-t border-neutral-800 flex gap-3">
                        <input id="user-input" type="text" placeholder="與角色聊聊他的睡眠與生活細節..." class="flex-1 bg-neutral-800 border-none rounded-xl px-5 text-sm focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder:text-neutral-700">
                        <button onclick="handleSend()" id="send-btn" class="p-3 bg-white text-black rounded-xl hover:bg-neutral-200 transition-all shadow-lg">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- 戰略報告 -->
                <div id="report-view" class="hidden p-8 overflow-y-auto custom-scrollbar h-full bg-neutral-900">
                    <div class="flex justify-between items-start mb-8 border-b border-neutral-800 pb-4">
                        <h2 class="text-xl font-black flex items-center gap-3 text-white uppercase tracking-tight">
                            <i data-lucide="sparkles" class="text-indigo-400"></i> Strategic Insights
                        </h2>
                        <button onclick="closeReport()" class="px-4 py-2 border border-neutral-700 rounded-xl text-[10px] font-black hover:bg-neutral-800 uppercase tracking-widest">關閉報告</button>
                    </div>
                    <div id="report-content" class="grid md:grid-cols-2 gap-8 text-sm">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PERSONAS = {
            menopause: {
                id: 'menopause',
                name: '林太太',
                age: '52歲',
                role: '更年期女性',
                tags: ['#更年期', '#盜汗', '#情緒起伏'],
                imagePrompt: 'A hyper-realistic cinematic portrait photography of a 52-year-old East Asian woman, looking extremely exhausted, sitting in a dimly lit bedroom at night, showing realistic skin texture, visible dark circles, messy hair, photorealistic 8k.',
                greeting: '唉...你好，我是林太太。\n\n你也是因為睡不著才來聊天的嗎？\n\n我剛剛又熱到整身汗醒過來，真的快瘋了...',
                systemPrompt: "你現在是林太太。規則：1.嚴禁長篇大論。2.每一句話都要強制換行。3.語氣自然，像手機傳簡訊。4.描述盜汗、踢被子等生理細節，並帶有情緒地訴說對身體衰老的無奈。"
            },
            worker: {
                id: 'worker',
                name: 'Jason',
                age: '38歲',
                role: '資深工程主管',
                tags: ['#報復性熬夜', '#資深主管', '#藍光暴露'],
                imagePrompt: 'A photorealistic close-up photo of a 38-year-old Asian man with glasses in a dark home office at 2 AM, face illuminated by blue light of a monitor, visible facial pores, tired red eyes, cinematic realism 8k.',
                greeting: '嘿...我是 Jason。\n\n快兩點了，我還坐在電腦前，但我不想睡。\n\n我只是想安靜滑一下手機。你也有這種感覺嗎？',
                systemPrompt: "你現在是 Jason。規則：1.說話要短。2.頻繁使用換行。3.帶點理性疲憊感。4.隨機提到職場 Deadline、責任制壓力、或被手機藍光制約的無奈。"
            },
            chronic: {
                id: 'chronic',
                name: '凱文',
                age: '40歲',
                role: '長期失眠者',
                tags: ['#長期失眠', '#藥物焦慮', '#床鋪恐懼'],
                imagePrompt: 'A high-definition realistic portrait of a 40-year-old Asian man staring at the ceiling in the dark, heavy bags under eyes, expression of hopelessness, photorealistic skin texture 8k.',
                greeting: '你好...我是凱文。\n\n說實話，我不覺得聊天會有用。\n\n這十年來我什麼方法都試過了，但我的床就像戰場...',
                systemPrompt: "你現在是凱文。規則：1.語氣低沈、短小。2.每一句都要換行。3.描述失眠時的心跳聲、牆上影子。4.表現出對藥物依賴的焦慮與對恢復正常睡眠的絕望感。"
            },
            elder: {
                id: 'elder',
                name: '王伯伯',
                age: '68歲',
                role: '退休長輩',
                tags: ['#銀髮族', '#早醒', '#半夜頻尿'],
                imagePrompt: 'A highly detailed realistic photo of a 68-year-old Asian elderly man, sitting on a wooden chair by a window at 4 AM, looking thoughtful and lonely, soft dawn lighting 8k.',
                greeting: '你好啊小伙子，我是王老伯。\n\n這時間...天都還沒亮，你怎麼也沒睡？是工作壓力太大嗎？',
                systemPrompt: "你現在是王伯伯。規則：1.語氣緩慢、帶感嘆。2.每一句話後面都要換行。3.像老人家在手機上打字般緩慢簡短。4.提到半夜跑廁所、看著窗外天亮的孤單感。"
            }
        };

        let currentPersona = null;
        let messages = [];
        let isGenerating = false;

        window.onload = () => {
            renderSelection();
            lucide.createIcons();
            document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
        };

        function renderSelection() {
            const container = document.getElementById('selection-screen');
            container.innerHTML = Object.values(PERSONAS).map(p => `
                <div onclick="selectPersona('${p.id}')" class="persona-card bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden cursor-pointer hover:border-indigo-500 transition-all group">
                    <div class="aspect-[3/2] bg-neutral-800 relative overflow-hidden">
                        <div id="card-loader-${p.id}" class="absolute inset-0 flex items-center justify-center bg-neutral-800">
                             <i data-lucide="loader-2" class="animate-spin text-neutral-600 w-6 h-6"></i>
                        </div>
                        <img id="card-img-${p.id}" src="" class="card-img w-full h-full object-cover transition-transform duration-700 hidden">
                        <div class="absolute inset-0 bg-gradient-to-t from-neutral-900 via-transparent to-transparent"></div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg mb-1">${p.name} <span class="text-sm font-normal text-neutral-500">${p.age}</span></h3>
                        <div class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">${p.role}</div>
                        <div class="flex flex-wrap gap-1">
                            ${p.tags.map(t => `<span class="text-[9px] text-neutral-500 font-medium">${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
            Object.values(PERSONAS).forEach(p => fetchCardImage(p));
        }

        async function fetchCardImage(p) {
            if (!API_KEY) return;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt: p.imagePrompt }, parameters: { sampleCount: 1 } })
                });
                const data = await response.json();
                if (data.predictions?.[0]?.bytesBase64Encoded) {
                    const imgEl = document.getElementById(`card-img-${p.id}`);
                    const loaderEl = document.getElementById(`card-loader-${p.id}`);
                    imgEl.src = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    imgEl.classList.remove('hidden');
                    loaderEl.classList.add('hidden');
                }
            } catch (e) { 
                console.error("Image failed", p.id); 
                document.getElementById(`card-loader-${p.id}`).innerHTML = '<i data-lucide="image-off" class="text-neutral-700"></i>';
                lucide.createIcons();
            }
        }

        async function selectPersona(id) {
            currentPersona = PERSONAS[id];
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('back-btn-container').classList.remove('hidden');

            document.getElementById('character-name').innerText = currentPersona.name;
            document.getElementById('character-info').innerText = `${currentPersona.age} | ${currentPersona.role}`;
            document.getElementById('character-tags').innerHTML = currentPersona.tags.map(t => `<span class="px-2 py-0.5 bg-indigo-500/20 text-indigo-400 text-[10px] rounded border border-indigo-500/30">${t}</span>`).join('');
            
            const photoEl = document.getElementById('character-photo');
            const loadingEl = document.getElementById('photo-loading');
            const cardImg = document.getElementById(`card-img-${id}`);
            
            if (cardImg && cardImg.src) {
                photoEl.src = cardImg.src;
                photoEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
            }

            messages = [{ role: 'assistant', content: currentPersona.greeting }];
            renderMessages();
        }

        function resetApp() {
            currentPersona = null;
            messages = [];
            document.getElementById('selection-screen').classList.remove('hidden');
            document.getElementById('main-interface').classList.add('hidden');
            document.getElementById('back-btn-container').classList.add('hidden');
            document.getElementById('report-view').classList.add('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
        }

        function renderMessages() {
            const container = document.getElementById('messages-list');
            container.innerHTML = messages.map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="p-4 rounded-2xl max-w-[85%] text-sm leading-[1.8] shadow-sm ${m.role === 'user' ? 'chat-bubble-user text-white' : 'chat-bubble-ai text-neutral-100'}">
                        <p class="whitespace-pre-wrap">${m.content}</p>
                    </div>
                </div>
            `).join('');
            
            if (isGenerating) {
                container.innerHTML += `
                    <div class="flex justify-start">
                        <div class="bg-neutral-800 p-4 rounded-2xl flex gap-1.5 border border-neutral-700">
                            <div class="w-1.5 h-1.5 bg-neutral-600 rounded-full dot-loading"></div>
                            <div class="w-1.5 h-1.5 bg-neutral-600 rounded-full dot-loading" style="animation-delay: 0.2s"></div>
                            <div class="w-1.5 h-1.5 bg-neutral-600 rounded-full dot-loading" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                `;
            }
            container.scrollTop = container.scrollHeight;
        }

        async function handleSend() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            if (!text || isGenerating || !API_KEY) return;

            inputEl.value = '';
            messages.push({ role: 'user', content: text });
            isGenerating = true;
            renderMessages();

            try {
                const history = messages.slice(-6).map(m => `${m.role === 'assistant' ? '角色' : '使用者'}: ${m.content}`).join('\n');
                const prompt = `${history}\n使用者現在說了: ${text}\n請根據角色性格與情緒給出自然且不重複的回應，並務必頻繁換行：`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: currentPersona.systemPrompt }] },
                        generationConfig: { temperature: 0.85, topP: 0.95, maxOutputTokens: 1000 }
                    })
                });
                
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (aiText) messages.push({ role: 'assistant', content: aiText });
            } catch (e) {
                messages.push({ role: 'assistant', content: "（連線似乎不太穩，我剛才的話沒說完...）" });
            } finally {
                isGenerating = false;
                renderMessages();
            }
        }

        async function runAnalysis() {
            if (messages.length < 2 || isGenerating) return;
            isGenerating = true;
            const btn = document.getElementById('analysis-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> 戰略分析中...`;
            lucide.createIcons();

            try {
                const history = messages.map(m => `${m.role}: ${m.content}`).join('\n');
                const analysisPrompt = `分析對話內容，產出 SEO 與內容策略報告。請回傳 JSON：
                {
                    "personaTraits": "描述性格背景",
                    "characterQuestions": ["3個具備 SEO 價值、搜尋意圖的核心疑問 (過濾寒暄語)"],
                    "barriers": ["2個認知障礙"],
                    "seoKeywords": ["5個推薦關鍵字"],
                    "faqContent": ["3個專業建議"],
                    "aiOverviewStrategy": "AI Overview 策略"
                }
                對話實錄：\n${history}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: analysisPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                showReport(result);
            } catch (e) { console.error("Analysis failed", e); } finally {
                isGenerating = false;
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        function showReport(data) {
            document.getElementById('chat-container').classList.add('hidden');
            document.getElementById('report-view').classList.remove('hidden');
            const content = document.getElementById('report-content');
            content.innerHTML = `
                <div class="space-y-6">
                    <section>
                        <h4 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="help-circle" class="w-3 h-3"></i> SEO FAQ (核心疑問)
                        </h4>
                        ${data.characterQuestions.map(q => `<div class="p-4 bg-indigo-950/20 rounded-xl border border-indigo-900/30 mb-2 italic shadow-inner leading-relaxed text-neutral-200">「${q}」</div>`).join('')}
                    </section>
                    <section>
                        <h4 class="text-[10px] font-black text-red-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="alert-circle" class="w-3 h-3"></i> 認知障礙
                        </h4>
                        <ul class="text-neutral-400 space-y-2 pl-2">
                            ${data.barriers.map(b => `<li class="flex gap-2 font-medium"><span>•</span>${b}</li>`).join('')}
                        </ul>
                    </section>
                </div>
                <div class="space-y-6">
                    <section>
                        <h4 class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-3 h-3"></i> 推薦搜尋詞
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            ${data.seoKeywords.map(k => `<span class="px-2 py-1 bg-neutral-800 text-emerald-400 text-[10px] rounded border border-neutral-700 font-bold">${k}</span>`).join('')}
                        </div>
                    </section>
                    <section>
                        <h4 class="text-[10px] font-black text-yellow-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="brain" class="w-3 h-3"></i> AI Overview 策略
                        </h4>
                        <div class="p-4 bg-yellow-900/10 rounded-xl border border-yellow-900/20 text-neutral-300 leading-relaxed font-medium">
                            ${data.aiOverviewStrategy}
                        </div>
                    </section>
                </div>
            `;
            lucide.createIcons();
        }

        function closeReport() {
            document.getElementById('report-view').classList.add('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }
    </script>
</body>
</html>
